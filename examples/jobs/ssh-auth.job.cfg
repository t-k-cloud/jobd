[key-setup]
exe = ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa
if_not = ls ~/.ssh/id_rsa ~/.ssh/id_rsa.pub

[key-cleanup]
exe = rm -f ~/.ssh/id_rsa ~/.ssh/id_rsa.pub

[agent-refresh]
exe = ssh-agent -s > ~/ssh-agent.sh && chmod +x ~/ssh-agent.sh && source ~/ssh-agent.sh && ssh-add

[localhost-setup]
exe = $JOBSDIR/ssh-auth-setup.sh "$(cat ~/.ssh/id_rsa.pub)"
dep[] = sshd:up
dep[] = ssh-auth:key-setup
dep[] = ssh-auth:agent-refresh

[localhost-cleanup]
exe = rm -f ~/.ssh/authorized_keys
dep[] = ssh-auth:key-cleanup

[localhost-test]
exe = source ~/ssh-agent.sh && ssh tk@localhost 'ls /'

[remotehost-setup]
exe = ssh $SSHTO 'bash -s' -- < $JOBSDIR/ssh-auth-setup.sh "'$(cat ~/.ssh/id_rsa.pub)'"
dep[] = ssh-auth:key-setup
dep[] = ssh-auth:agent-refresh

[remotehost-cleanup]
exe = ssh $SSHTO 'rm -f ~/.ssh/authorized_keys'

[remotehost-test]
exe = source ~/ssh-agent.sh && ssh $SSHTO 'ls /'

[setup]
dep[] = ssh-auth:localhost-setup
dep[] = ssh-auth:remotehost-setup

[cleanup]
dep[] = ssh-auth:localhost-cleanup
dep[] = ssh-auth:remotehost-cleanup
