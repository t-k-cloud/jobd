[up]
exer = root
exe = systemctl start nginx
dep[] = nginx:installed

[installed]
exer = root
exe = pacman --noconfirm -S nginx
if_not = which nginx

[down]
exer = root
exe = systemctl stop nginx
dep[] = nginx:up

[nginx-cfg]
exe = cp $JOBSDIR/nginx-config/nginx.conf /etc/nginx/sites-available/default
dep[] = nginx:installed

[php-installed]
exer = root
exe = pacman --noconfirm -S php-fpm php-gd php-curl

[php-patch]
exer = root
exe = $JOBSDIR/php-config/patch-ini.sh 'php-fpm'
dep[] = nginx:php-installed

[php-test]
exe = cp -r $JOBSDIR/php-config/php-test /usr/share/nginx/html/
dep[] = nginx:php-installed

[php-setup]
exe = systemctl restart $(systemctl list-unit-files | grep fpm | grep php | awk "{print \$1}")
dep[] = nginx:php-patch
dep[] = nginx:php-test

[nginx-setup]
exe = ssh $SSHTO 'systemctl restart nginx'
dep[] = nginx:nginx-cfg

[setup]
dep[] = nginx:php-setup
dep[] = nginx:nginx-setup

[srv-installed]
exe = ssh $SSHTO 'apt-get install -y nginx'
if_not = ssh $SSHTO 'which nginx'

[srv-up]
exe = ssh $SSHTO 'systemctl start nginx'
dep[] = nginx:srv-installed

[srv-down]
exe = ssh $SSHTO 'systemctl stop nginx'
dep[] = nginx:srv-up

[srv-reloaded]
exe = ssh $SSHTO 'systemctl reload nginx'
dep[] = nginx:srv-up

[srv-nginx-cfg]
exe = scp $JOBSDIR/nginx-config/nginx.conf $SSHTO:/etc/nginx/sites-available/default
dep[] = nginx:srv-installed

[srv-revprox-file]
exe = scp $JOBSDIR/nginx-config/revprox.php $SSHTO:/usr/share/nginx/html/
dep[] = nginx:srv-installed

[srv-php-installed]
exe = ssh $SSHTO 'apt-get install -y php-fpm php-gd php-curl'

[srv-php-patch]
exe = ssh $SSHTO 'bash -s' -- < $JOBSDIR/php-config/patch-ini.sh 'php-fpm7.0'
dep[] = nginx:srv-php-installed

[srv-php-test]
exe = scp -r $JOBSDIR/php-config/php-test $SSHTO:/usr/share/nginx/html/
dep[] = nginx:srv-php-installed

[srv-php-setup]
exe = ssh $SSHTO 'systemctl restart $(systemctl list-unit-files | grep fpm | grep php | awk "{print \$1}")'
dep[] = nginx:srv-php-patch
dep[] = nginx:srv-php-test

[srv-nginx-setup]
exe = ssh $SSHTO 'systemctl restart nginx'
dep[] = nginx:srv-nginx-cfg
dep[] = nginx:srv-revprox-file

[srv-setup]
dep[] = nginx:srv-php-setup
dep[] = nginx:srv-nginx-setup
